<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVC Viewer ‚Äî Pipeline Visualization</title>
    <meta name="description" content="Interactive DAG visualization for DVC pipelines">

    <!-- Cytoscape.js + Dagre layout -->
    <script src="https://unpkg.com/cytoscape@3.30.4/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: rgba(17, 24, 39, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.06);
            --border-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.15);

            /* State colors */
            --state-valid: #22c55e;
            --state-valid-bg: rgba(34, 197, 94, 0.12);
            --state-valid-glow: rgba(34, 197, 94, 0.4);
            --state-rerun: #f59e0b;
            --state-rerun-bg: rgba(245, 158, 11, 0.12);
            --state-rerun-glow: rgba(245, 158, 11, 0.4);
            --state-never: #64748b;
            --state-never-bg: rgba(100, 116, 139, 0.12);
            --state-never-glow: rgba(100, 116, 139, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            font-size: 20px;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        .header-title {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* ‚îÄ‚îÄ‚îÄ Legend ‚îÄ‚îÄ‚îÄ */
        .legend {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

        .legend-dot.valid {
            background: var(--state-valid);
            color: var(--state-valid);
        }

        .legend-dot.rerun {
            background: var(--state-rerun);
            color: var(--state-rerun);
        }

        .legend-dot.never {
            background: var(--state-never);
            color: var(--state-never);
        }

        /* ‚îÄ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ‚îÄ */
        .main {
            display: flex;
            height: calc(100vh - 56px);
            margin-top: 56px;
        }

        /* ‚îÄ‚îÄ‚îÄ Graph container ‚îÄ‚îÄ‚îÄ */
        .graph-container {
            flex: 1;
            position: relative;
            background:
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.04) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(34, 197, 94, 0.03) 0%, transparent 50%),
                var(--bg-primary);
        }

        /* Grid pattern */
        .graph-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        #cy {
            width: 100%;
            height: 100%;
        }

        /* ‚îÄ‚îÄ‚îÄ Stats bar ‚îÄ‚îÄ‚îÄ */
        .stats-bar {
            position: absolute;
            bottom: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
        }

        .stat-chip {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-chip .count {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ */
        .sidebar {
            width: 380px;
            min-width: 260px;
            max-width: 60vw;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar-resize-handle {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            z-index: 10;
            background: transparent;
            transition: background 0.15s ease;
        }

        .sidebar-resize-handle:hover,
        .sidebar-resize-handle.active {
            background: var(--accent);
        }

        .sidebar.collapsed {
            transform: translateX(100%);
        }

        .sidebar-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-stage-name {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .state-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 10px;
            border-radius: 100px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .state-badge.valid {
            background: var(--state-valid-bg);
            color: var(--state-valid);
            box-shadow: 0 0 12px var(--state-valid-glow);
        }

        .state-badge.needs_rerun {
            background: var(--state-rerun-bg);
            color: var(--state-rerun);
            box-shadow: 0 0 12px var(--state-rerun-glow);
        }

        .state-badge.never_run {
            background: var(--state-never-bg);
            color: var(--state-never);
        }

        .sidebar-command {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            word-break: break-all;
            margin-top: 8px;
        }

        /* ‚îÄ‚îÄ‚îÄ Sidebar sections ‚îÄ‚îÄ‚îÄ */
        .sidebar-content {
            padding: 0;
            flex: 1;
        }

        .sidebar-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .file-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .file-item {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 6px 10px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .file-item:hover {
            background: var(--accent-glow);
            border-color: var(--border-glow);
            color: var(--text-primary);
        }

        .file-item .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .file-item .status-dot.current {
            background: var(--state-valid);
            box-shadow: 0 0 6px var(--state-valid-glow);
        }

        .file-item .status-dot.outdated {
            background: var(--state-rerun);
            box-shadow: 0 0 6px var(--state-rerun-glow);
        }

        .file-item .status-dot.missing {
            background: #ef4444;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.4);
        }

        .file-item .status-dot.unknown {
            background: var(--state-never);
            box-shadow: 0 0 6px var(--state-never-glow);
        }

        .file-item.status-current {
            border-left: 3px solid var(--state-valid);
        }

        .file-item.status-outdated {
            border-left: 3px solid var(--state-rerun);
        }

        .file-item.status-missing {
            border-left: 3px solid #ef4444;
        }

        .file-item.status-unknown {
            border-left: 3px solid var(--state-never);
        }

        .file-item.param::before {
            content: '‚öôÔ∏è ';
            font-size: 11px;
        }

        .file-item.metric::before {
            content: 'üìä ';
            font-size: 11px;
        }

        .file-item.plot::before {
            content: 'üìà ';
            font-size: 11px;
        }

        /* ‚îÄ‚îÄ‚îÄ Empty sidebar ‚îÄ‚îÄ‚îÄ */
        .sidebar-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
        }

        .sidebar-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .sidebar-empty-text {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        /* ‚îÄ‚îÄ‚îÄ Loading state ‚îÄ‚îÄ‚îÄ */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-muted);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Error state ‚îÄ‚îÄ‚îÄ */
        .error-container {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 40px;
            text-align: center;
        }

        .error-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .error-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .error-message {
            font-size: 14px;
            color: var(--text-muted);
            max-width: 400px;
        }

        /* ‚îÄ‚îÄ‚îÄ Tooltip on graph ‚îÄ‚îÄ‚îÄ */
        .cy-tooltip {
            position: absolute;
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--text-primary);
            pointer-events: none;
            z-index: 50;
            white-space: nowrap;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transform: translate(-50%, -100%);
            margin-top: -12px;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .cy-tooltip.visible {
            opacity: 1;
        }

        /* ‚îÄ‚îÄ‚îÄ Fit button ‚îÄ‚îÄ‚îÄ */
        .controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ctrl-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .ctrl-btn:hover {
            background: var(--accent-glow);
            border-color: var(--border-glow);
            color: var(--text-primary);
        }

        /* ‚îÄ‚îÄ‚îÄ Clickable file items ‚îÄ‚îÄ‚îÄ */
        .file-item.inspectable {
            cursor: pointer;
            position: relative;
            padding-right: 32px;
        }

        .file-item.inspectable::after {
            content: 'üîç';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            opacity: 0.4;
            transition: all 0.15s ease;
        }

        .file-item.inspectable:hover {
            background: var(--accent-glow);
            border-color: var(--accent);
        }

        .file-item.inspectable:hover::after {
            opacity: 1;
        }

        .new-result-badge {
            display: inline-block;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.05em;
            padding: 1px 6px;
            border-radius: 100px;
            background: var(--accent);
            color: #fff;
            margin-left: 6px;
            animation: badge-pulse 1.5s ease-in-out infinite;
            vertical-align: middle;
            line-height: 1.4;
        }

        @keyframes badge-pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.5);
            }

            50% {
                opacity: 0.85;
                transform: scale(1.1);
                box-shadow: 0 0 8px 2px rgba(99, 102, 241, 0.3);
            }
        }

        /* Node badges on graph */
        .node-badge {
            position: absolute;
            z-index: 100;
            pointer-events: none;
            font-family: 'Inter', sans-serif;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.05em;
            padding: 2px 7px;
            border-radius: 100px;
            background: var(--accent);
            color: #fff;
            white-space: nowrap;
            animation: node-badge-pulse 1.5s ease-in-out infinite;
            transform: translate(-50%, -100%);
        }

        @keyframes node-badge-pulse {

            0%,
            100% {
                opacity: 1;
                transform: translate(-50%, -100%) scale(1);
                box-shadow: 0 0 4px rgba(99, 102, 241, 0.6);
            }

            50% {
                opacity: 0.85;
                transform: translate(-50%, -100%) scale(1.15);
                box-shadow: 0 0 12px 3px rgba(99, 102, 241, 0.4);
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Inspector Modal ‚îÄ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 32px;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90vw;
            max-width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title-icon {
            font-size: 18px;
        }

        .modal-file-badge {
            font-size: 11px;
            font-weight: 400;
            padding: 2px 8px;
            border-radius: 6px;
            background: var(--accent-glow);
            color: var(--accent);
            border: 1px solid var(--border-glow);
            text-transform: uppercase;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .modal-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 24px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .modal-search {
            flex: 1;
            max-width: 300px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            outline: none;
            transition: border-color 0.15s ease;
        }

        .modal-search:focus {
            border-color: var(--border-glow);
        }

        .modal-search::placeholder {
            color: var(--text-muted);
        }

        .modal-stats {
            font-size: 12px;
            color: var(--text-muted);
        }

        .modal-body {
            flex: 1;
            overflow: auto;
            padding: 0;
        }

        /* ‚îÄ‚îÄ‚îÄ CSV Table ‚îÄ‚îÄ‚îÄ */
        .csv-table-wrap {
            overflow: auto;
            max-height: 100%;
        }

        .csv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .csv-table th {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: 10px 14px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            z-index: 10;
        }

        .csv-table th:hover {
            color: var(--text-primary);
        }

        .csv-table th .sort-arrow {
            margin-left: 4px;
            font-size: 10px;
            opacity: 0.4;
        }

        .csv-table th.sorted .sort-arrow {
            opacity: 1;
            color: var(--accent);
        }

        .csv-table td {
            padding: 8px 14px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: nowrap;
        }

        .csv-table tr:hover td {
            background: var(--bg-glass);
            color: var(--text-primary);
        }

        .csv-table td.numeric {
            text-align: right;
            color: var(--accent);
        }

        /* ‚îÄ‚îÄ‚îÄ Image viewer ‚îÄ‚îÄ‚îÄ */
        .image-viewer {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
            min-height: 300px;
        }

        .image-viewer img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* ‚îÄ‚îÄ‚îÄ PDF viewer ‚îÄ‚îÄ‚îÄ */
        .pdf-viewer {
            width: 100%;
            height: 100%;
            min-height: 70vh;
        }

        .pdf-viewer iframe {
            width: 100%;
            height: 70vh;
            border: none;
        }

        /* ‚îÄ‚îÄ‚îÄ Text viewer ‚îÄ‚îÄ‚îÄ */
        .text-viewer {
            padding: 20px 24px;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ‚îÄ‚îÄ‚îÄ File not found ‚îÄ‚îÄ‚îÄ */
        .file-not-found {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            text-align: center;
        }

        .file-not-found-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .file-not-found-text {
            font-size: 14px;
            color: var(--text-muted);
        }

        .file-not-found-path {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--bg-glass);
            border-radius: 6px;
        }

        /* ‚îÄ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ‚îÄ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ‚îÄ‚îÄ‚îÄ Run Buttons ‚îÄ‚îÄ‚îÄ */
        .run-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: 1px solid var(--border-glow);
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .run-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3));
            border-color: #818cf8;
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.3);
            transform: translateY(-1px);
        }

        .run-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .run-btn.running {
            animation: pulse-glow 1.5s ease-in-out infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(99, 102, 241, 0.2);
            }

            50% {
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
            }
        }

        .run-btn-sidebar {
            width: 100%;
            justify-content: center;
            margin-top: 12px;
            padding: 10px 16px;
        }

        .run-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: none;
        }

        .run-btn.running .run-spinner {
            display: inline-block;
        }

        .run-btn.running .run-icon {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Execution Toast (small status indicator) ‚îÄ‚îÄ‚îÄ */
        .exec-toast {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            background: var(--bg-card);
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            padding: 10px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            color: var(--text-primary);
            gap: 10px;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            transition: all 0.3s ease;
        }

        .exec-toast.active {
            display: flex;
        }

        .exec-toast .toast-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-top-color: #818cf8;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .exec-toast .toast-icon {
            font-size: 16px;
        }

        .exec-toast .toast-text {
            font-weight: 500;
        }

        .exec-toast.success {
            border-color: rgba(52, 211, 153, 0.4);
        }

        .exec-toast.error {
            border-color: rgba(239, 68, 68, 0.4);
        }

        /* ‚îÄ‚îÄ‚îÄ Sidebar Execution Logs ‚îÄ‚îÄ‚îÄ */
        .sidebar-logs {
            margin-top: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }

        .sidebar-logs-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .sidebar-logs-title {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }

        .sidebar-logs-duration {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--accent);
            margin-left: 8px;
            font-weight: 500;
        }

        .sidebar-logs-copy {
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .sidebar-logs-copy:hover {
            background: var(--accent-glow);
            color: var(--text-primary);
        }

        .sidebar-logs-content {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 0;
        }

        .sidebar-logs-empty {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
            padding: 8px 0;
        }

        /* ‚îÄ‚îÄ‚îÄ Error state on nodes ‚îÄ‚îÄ‚îÄ */
        .cy-node-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6) !important;
        }

        /* ‚îÄ‚îÄ‚îÄ Version Navigation ‚îÄ‚îÄ‚îÄ */
        .version-nav {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            background: rgba(30, 41, 59, 0.6);
            border-bottom: 1px solid var(--border);
            font-family: 'Inter', sans-serif;
            font-size: 12px;
        }

        .version-nav.active {
            display: flex;
        }

        .version-nav-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .version-nav-btn:hover:not(:disabled) {
            background: var(--accent-glow);
            border-color: var(--border-glow);
            color: var(--text-primary);
        }

        .version-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .version-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .version-commit-msg {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .version-commit-meta {
            color: var(--text-muted);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .version-counter {
            color: var(--text-muted);
            font-size: 11px;
            white-space: nowrap;
            font-family: 'JetBrains Mono', monospace;
        }

        .version-current-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
            letter-spacing: 0.05em;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <span class="header-logo">üîç</span>
            <div>
                <div class="header-title">DVC Viewer</div>
                <div class="header-subtitle">Pipeline Visualization</div>
            </div>
        </div>
        <div class="header-right">
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-dot valid"></span>
                    Valid
                </div>
                <div class="legend-item">
                    <span class="legend-dot rerun"></span>
                    Needs rerun
                </div>
                <div class="legend-item">
                    <span class="legend-dot never"></span>
                    Never run
                </div>
            </div>
        </div>
        <button class="run-btn" id="btn-run-all" title="Run entire pipeline">
            <span class="run-icon">‚ñ∂</span>
            <span class="run-spinner"></span>
            Run All
        </button>
        </div>
    </header>

    <!-- Main -->
    <main class="main">
        <!-- Graph -->
        <div class="graph-container">
            <div id="cy"></div>
            <div id="node-badges-layer"
                style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;">
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="ctrl-btn" id="btn-fit" title="Fit to viewport">‚ä°</button>
                <button class="ctrl-btn" id="btn-zoom-in" title="Zoom in">+</button>
                <button class="ctrl-btn" id="btn-zoom-out" title="Zoom out">‚àí</button>
            </div>

            <!-- Stats -->
            <div class="stats-bar" id="stats-bar"></div>

            <!-- Tooltip -->
            <div class="cy-tooltip" id="tooltip"></div>

            <!-- Loading -->
            <div class="loading-overlay" id="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading pipeline‚Ä¶</div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-resize-handle" id="sidebar-resize"></div>
            <div class="sidebar-empty" id="sidebar-empty">
                <div class="sidebar-empty-icon">üéØ</div>
                <div class="sidebar-empty-text">
                    Click on a node to inspect<br>its details
                </div>
            </div>
            <div id="sidebar-detail" style="display: none;">
                <div class="sidebar-header">
                    <div class="sidebar-stage-name">
                        <span id="detail-name"></span>
                        <span class="state-badge" id="detail-badge"></span>
                    </div>
                    <div class="sidebar-command" id="detail-cmd"></div>
                </div>
                <div class="sidebar-content" id="detail-sections"></div>
                <button class="run-btn run-btn-sidebar" id="btn-run-stage" title="Run this stage">
                    <span class="run-icon">‚ñ∂</span>
                    <span class="run-spinner"></span>
                    Run Stage
                </button>
                <div id="sidebar-logs-container"></div>
            </div>
        </aside>
    </main>

    <!-- Execution Toast -->
    <div class="exec-toast" id="exec-toast">
        <div class="toast-spinner" id="toast-spinner"></div>
        <span class="toast-icon" id="toast-icon" style="display:none;"></span>
        <span class="toast-text" id="toast-text">Running pipeline‚Ä¶</span>
    </div>

    <!-- File Inspector Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-title-icon" id="modal-icon">üìÑ</span>
                    <span id="modal-filename">file.csv</span>
                    <span class="modal-file-badge" id="modal-badge">CSV</span>
                </div>
                <button class="modal-close" id="modal-close">‚úï</button>
            </div>
            <div class="modal-toolbar" id="modal-toolbar" style="display: none;">
                <input class="modal-search" id="modal-search" type="text" placeholder="Filter rows...">
                <span class="modal-stats" id="modal-stats"></span>
            </div>
            <div class="version-nav" id="version-nav">
                <button class="version-nav-btn" id="version-prev" title="Previous version">‚óÄ</button>
                <div class="version-info">
                    <div class="version-commit-msg" id="version-msg">Loading history‚Ä¶</div>
                    <div class="version-commit-meta" id="version-meta"></div>
                </div>
                <span class="version-counter" id="version-counter"></span>
                <button class="version-nav-btn" id="version-next" title="Next version">‚ñ∂</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script>
        (function () {
            "use strict";

            // ‚îÄ‚îÄ‚îÄ State colors ‚îÄ‚îÄ‚îÄ
            const STATE_COLORS = {
                valid: { bg: '#166534', border: '#22c55e', text: '#f0fdf4', glow: 'rgba(34,197,94,0.5)' },
                needs_rerun: { bg: '#78350f', border: '#f59e0b', text: '#fefce8', glow: 'rgba(245,158,11,0.5)' },
                never_run: { bg: '#1e293b', border: '#64748b', text: '#cbd5e1', glow: 'rgba(100,116,139,0.3)' },
            };

            const STATE_LABELS = {
                valid: 'Valid',
                needs_rerun: 'Needs rerun',
                never_run: 'Never run',
            };

            let cy = null;

            // ‚îÄ‚îÄ‚îÄ Fetch pipeline data ‚îÄ‚îÄ‚îÄ
            async function fetchPipeline() {
                const res = await fetch('/api/pipeline');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            }

            // ‚îÄ‚îÄ‚îÄ Build Cytoscape elements ‚îÄ‚îÄ‚îÄ
            function buildElements(data) {
                const elements = [];

                for (const node of data.nodes) {
                    const sc = STATE_COLORS[node.state] || STATE_COLORS.never_run;
                    elements.push({
                        group: 'nodes',
                        data: {
                            id: node.id,
                            label: node.id,
                            state: node.state,
                            cmd: node.cmd,
                            deps: node.deps,
                            outs: node.outs,
                            params: node.params || [],
                            metrics: node.metrics || [],
                            plots: node.plots || [],
                            bgColor: sc.bg,
                            borderColor: sc.border,
                            textColor: sc.text,
                            glowColor: sc.glow,
                        },
                    });
                }

                for (const edge of data.edges) {
                    elements.push({
                        group: 'edges',
                        data: {
                            id: `${edge.source}->${edge.target}`,
                            source: edge.source,
                            target: edge.target,
                            label: edge.label || '',
                        },
                    });
                }

                return elements;
            }

            // ‚îÄ‚îÄ‚îÄ Init Cytoscape ‚îÄ‚îÄ‚îÄ
            function initGraph(elements) {
                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    layout: {
                        name: 'dagre',
                        rankDir: 'TB',
                        nodeSep: 60,
                        rankSep: 80,
                        edgeSep: 30,
                        padding: 50,
                        animate: true,
                        animationDuration: 600,
                        animationEasing: 'ease-out-cubic',
                    },
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(label)',
                                'width': 'label',
                                'height': 40,
                                'padding': '16px',
                                'shape': 'roundrectangle',
                                'background-color': 'data(bgColor)',
                                'border-width': 2,
                                'border-color': 'data(borderColor)',
                                'color': 'data(textColor)',
                                'font-family': "'Inter', sans-serif",
                                'font-size': 13,
                                'font-weight': 500,
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'text-wrap': 'none',
                                'transition-property': 'border-width, border-color, background-color',
                                'transition-duration': '0.15s',
                                'shadow-blur': 20,
                                'shadow-color': 'data(glowColor)',
                                'shadow-opacity': 0.6,
                                'shadow-offset-x': 0,
                                'shadow-offset-y': 4,
                            },
                        },
                        {
                            selector: 'node:active, node:selected',
                            style: {
                                'border-width': 3,
                                'border-color': '#6366f1',
                                'shadow-color': 'rgba(99, 102, 241, 0.6)',
                                'shadow-blur': 30,
                                'overlay-opacity': 0,
                            },
                        },
                        {
                            selector: 'node.hover',
                            style: {
                                'border-width': 3,
                            },
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 2,
                                'line-color': 'rgba(99, 102, 241, 0.35)',
                                'target-arrow-color': 'rgba(99, 102, 241, 0.55)',
                                'target-arrow-shape': 'triangle',
                                'arrow-scale': 1.1,
                                'curve-style': 'bezier',
                                'transition-property': 'line-color, target-arrow-color, width',
                                'transition-duration': '0.15s',
                            },
                        },
                        {
                            selector: 'edge:selected',
                            style: {
                                'width': 3,
                                'line-color': 'rgba(99, 102, 241, 0.7)',
                                'target-arrow-color': 'rgba(99, 102, 241, 0.9)',
                            },
                        },
                        {
                            selector: 'node.dimmed',
                            style: {
                                'opacity': 0.25,
                            },
                        },
                        {
                            selector: 'edge.dimmed',
                            style: {
                                'opacity': 0.12,
                            },
                        },
                        {
                            selector: 'node.highlighted',
                            style: {
                                'opacity': 1,
                            },
                        },
                        {
                            selector: 'edge.highlighted',
                            style: {
                                'opacity': 1,
                                'width': 3,
                                'line-color': 'rgba(99, 102, 241, 0.7)',
                                'target-arrow-color': 'rgba(99, 102, 241, 0.9)',
                            },
                        },
                    ],
                    minZoom: 0.2,
                    maxZoom: 3,
                    wheelSensitivity: 0.3,
                });

                // ‚îÄ‚îÄ‚îÄ Click on node ‚Üí select & show detail ‚îÄ‚îÄ‚îÄ
                cy.on('tap', 'node', function (evt) {
                    const node = evt.target;
                    selectedStage = node.data().id;
                    showDetail(node.data());
                    highlightNeighborhood(node);
                    removeNodeBadge(node.data().id);
                });

                // Reposition floating badges on pan/zoom
                cy.on('render', repositionNodeBadges);

                // ‚îÄ‚îÄ‚îÄ Click on background ‚Üí deselect ‚îÄ‚îÄ‚îÄ
                cy.on('tap', function (evt) {
                    if (evt.target === cy) {
                        selectedStage = null;
                        clearDetail();
                        clearHighlight();
                    }
                });

                // ‚îÄ‚îÄ‚îÄ Hover tooltip ‚îÄ‚îÄ‚îÄ
                const tooltip = document.getElementById('tooltip');
                cy.on('mouseover', 'node', function (evt) {
                    const node = evt.target;
                    node.addClass('hover');
                    const pos = node.renderedPosition();
                    const container = document.getElementById('cy').getBoundingClientRect();
                    tooltip.textContent = `${node.data('label')} ‚Äî ${STATE_LABELS[node.data('state')]}`;
                    tooltip.style.left = (pos.x) + 'px';
                    tooltip.style.top = (pos.y) + 'px';
                    tooltip.classList.add('visible');
                });

                cy.on('mouseout', 'node', function (evt) {
                    evt.target.removeClass('hover');
                    tooltip.classList.remove('visible');
                });

                // ‚îÄ‚îÄ‚îÄ Controls ‚îÄ‚îÄ‚îÄ
                document.getElementById('btn-fit').addEventListener('click', () => {
                    cy.fit(undefined, 50);
                });
                document.getElementById('btn-zoom-in').addEventListener('click', () => {
                    cy.zoom({ level: cy.zoom() * 1.3, renderedPosition: { x: cy.width() / 2, y: cy.height() / 2 } });
                });
                document.getElementById('btn-zoom-out').addEventListener('click', () => {
                    cy.zoom({ level: cy.zoom() / 1.3, renderedPosition: { x: cy.width() / 2, y: cy.height() / 2 } });
                });

                return cy;
            }

            // ‚îÄ‚îÄ‚îÄ Highlight execution chain (all upstream ancestors + the node) ‚îÄ‚îÄ‚îÄ
            function highlightNeighborhood(node) {
                cy.elements().addClass('dimmed');
                // BFS upstream: find all predecessors (stages that would run before this one)
                const chain = cy.collection().merge(node);
                const queue = [node];
                const visited = new Set([node.id()]);
                while (queue.length > 0) {
                    const current = queue.shift();
                    const preds = current.predecessors('node');
                    preds.forEach(pred => {
                        if (!visited.has(pred.id())) {
                            visited.add(pred.id());
                            chain.merge(pred);
                            queue.push(pred);
                        }
                    });
                }
                // Also include edges between chain nodes
                const chainEdges = chain.edgesWith(chain);
                chain.merge(chainEdges);
                chain.removeClass('dimmed').addClass('highlighted');
            }

            function clearHighlight() {
                cy.elements().removeClass('dimmed highlighted');
            }

            // ‚îÄ‚îÄ‚îÄ Sidebar detail ‚îÄ‚îÄ‚îÄ
            function showDetail(data) {
                document.getElementById('sidebar-empty').style.display = 'none';
                const detail = document.getElementById('sidebar-detail');
                detail.style.display = 'block';

                document.getElementById('detail-name').textContent = data.id;

                const badge = document.getElementById('detail-badge');
                badge.textContent = STATE_LABELS[data.state];
                badge.className = 'state-badge ' + data.state;

                document.getElementById('detail-cmd').textContent = data.cmd || '(no command)';

                const sections = document.getElementById('detail-sections');
                sections.innerHTML = '';

                // File items are now objects: {path, exists, status}
                const addFileSection = (title, items, cls = '', clickable = false) => {
                    if (!items || items.length === 0) return;
                    const sec = document.createElement('div');
                    sec.className = 'sidebar-section';
                    sec.innerHTML = `<div class="section-title">${title}</div>`;
                    const ul = document.createElement('ul');
                    ul.className = 'file-list';
                    for (const item of items) {
                        const path = typeof item === 'string' ? item : item.path;
                        const status = typeof item === 'string' ? 'unknown' : (item.status || 'unknown');
                        const canInspect = clickable && isInspectable(path);
                        const isNew = _updatedOutputs.has(path);
                        const li = document.createElement('li');
                        li.className = 'file-item' + (cls ? ' ' + cls : '') + ` status-${status}` + (canInspect ? ' inspectable' : '');
                        const dot = document.createElement('span');
                        dot.className = `status-dot ${status}`;
                        li.appendChild(dot);
                        li.appendChild(document.createTextNode(path));
                        if (isNew) {
                            const badge = document.createElement('span');
                            badge.className = 'new-result-badge';
                            badge.textContent = 'NEW';
                            li.appendChild(badge);
                        }
                        if (canInspect) {
                            li.addEventListener('click', (e) => {
                                e.stopPropagation();
                                _updatedOutputs.delete(path);
                                openFileInspector(path);
                                // Remove badge after opening
                                const b = li.querySelector('.new-result-badge');
                                if (b) b.remove();
                            });
                        }
                        ul.appendChild(li);
                    }
                    sec.appendChild(ul);
                    sections.appendChild(sec);
                };

                // Params remain plain strings
                const addSection = (title, items, cls = '') => {
                    if (!items || items.length === 0) return;
                    const sec = document.createElement('div');
                    sec.className = 'sidebar-section';
                    sec.innerHTML = `<div class="section-title">${title}</div>`;
                    const ul = document.createElement('ul');
                    ul.className = 'file-list';
                    for (const item of items) {
                        const li = document.createElement('li');
                        li.className = 'file-item' + (cls ? ' ' + cls : '');
                        li.textContent = item;
                        ul.appendChild(li);
                    }
                    sec.appendChild(ul);
                    sections.appendChild(sec);
                };

                addFileSection('Dependencies', data.deps, '', false);
                addFileSection('Outputs', data.outs, '', true);
                addSection('Parameters', data.params, 'param');
                addFileSection('Metrics', data.metrics, 'metric', true);
                addFileSection('Plots', data.plots, 'plot', true);

                // ‚îÄ‚îÄ‚îÄ Execution Logs section ‚îÄ‚îÄ‚îÄ
                const stageId = data.id;
                const logs = stageLogs[stageId];
                const timer = _stageTimers[stageId];
                const durationStr = timer && timer.duration ? ` ¬∑ ${formatElapsed(timer.duration)}` : '';
                const logsDiv = document.createElement('div');
                logsDiv.className = 'sidebar-logs';
                if (logs && logs.trim()) {
                    logsDiv.innerHTML = `
                        <div class="sidebar-logs-header">
                            <span class="sidebar-logs-title">Execution Logs<span class="sidebar-logs-duration">${durationStr}</span></span>
                            <button class="sidebar-logs-copy" data-stage="${stageId}">üìã Copy</button>
                        </div>
                        <pre class="sidebar-logs-content">${escapeHtml(logs)}</pre>
                    `;
                    logsDiv.querySelector('.sidebar-logs-copy').addEventListener('click', () => {
                        navigator.clipboard.writeText(stageLogs[stageId] || '').then(() => {
                            const btn = logsDiv.querySelector('.sidebar-logs-copy');
                            btn.textContent = '‚úÖ Copied!';
                            setTimeout(() => btn.textContent = 'üìã Copy', 2000);
                        });
                    });
                } else {
                    logsDiv.innerHTML = `
                        <div class="sidebar-logs-header">
                            <span class="sidebar-logs-title">Execution Logs</span>
                        </div>
                        <div class="sidebar-logs-empty">No execution logs yet</div>
                    `;
                }
                // Append logs below the Run Stage button
                const logsContainer = document.getElementById('sidebar-logs-container');
                logsContainer.innerHTML = '';
                logsContainer.appendChild(logsDiv);
            }

            function clearDetail() {
                document.getElementById('sidebar-empty').style.display = 'flex';
                document.getElementById('sidebar-detail').style.display = 'none';
            }

            // ‚îÄ‚îÄ‚îÄ Stats bar ‚îÄ‚îÄ‚îÄ
            function updateStats(data) {
                const counts = { valid: 0, needs_rerun: 0, never_run: 0 };
                for (const n of data.nodes) counts[n.state]++;

                const bar = document.getElementById('stats-bar');
                bar.innerHTML = `
            <div class="stat-chip"><span class="count">${data.nodes.length}</span> stages</div>
            <div class="stat-chip"><span class="count">${data.edges.length}</span> edges</div>
            <div class="stat-chip"><span class="count" style="color: var(--state-valid)">${counts.valid}</span> valid</div>
            <div class="stat-chip"><span class="count" style="color: var(--state-rerun)">${counts.needs_rerun}</span> needs rerun</div>
            <div class="stat-chip"><span class="count" style="color: var(--state-never)">${counts.never_run}</span> never run</div>
        `;
            }

            // ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ
            async function boot() {
                const loading = document.getElementById('loading');
                try {
                    const data = await fetchPipeline();
                    if (data.error) throw new Error(data.error);

                    const elements = buildElements(data);
                    initGraph(elements);
                    updateStats(data);

                    setTimeout(() => loading.classList.add('hidden'), 400);
                } catch (err) {
                    loading.innerHTML = `
                <div class="error-container">
                    <div class="error-icon">üí•</div>
                    <div class="error-title">Failed to load pipeline</div>
                    <div class="error-message">${err.message}</div>
                </div>
            `;
                }
            }

            // ‚îÄ‚îÄ‚îÄ File Inspector ‚îÄ‚îÄ‚îÄ
            const FILE_ICONS = {
                csv: 'üìä', image: 'üñºÔ∏è', pdf: 'üìï', text: 'üìÑ', binary: 'üì¶',
            };

            // ‚îÄ‚îÄ‚îÄ Version History State ‚îÄ‚îÄ‚îÄ
            let _versionHistory = [];    // Array of {hash, message, author, date}
            let _versionIndex = -1;      // -1 = current (working tree), 0 = most recent commit, etc.
            let _currentFilePath = null;
            let _currentFileType = null;

            async function loadFileHistory(filePath) {
                try {
                    const res = await fetch(`/api/file/history?path=${encodeURIComponent(filePath)}`);
                    const data = await res.json();
                    _versionHistory = data.commits || [];
                } catch {
                    _versionHistory = [];
                }
            }

            function updateVersionNav() {
                const nav = document.getElementById('version-nav');
                const prevBtn = document.getElementById('version-prev');
                const nextBtn = document.getElementById('version-next');
                const msg = document.getElementById('version-msg');
                const meta = document.getElementById('version-meta');
                const counter = document.getElementById('version-counter');

                if (_versionHistory.length === 0) {
                    nav.classList.remove('active');
                    return;
                }

                nav.classList.add('active');

                if (_versionIndex === -1) {
                    msg.innerHTML = '<span class="version-current-badge">CURRENT</span> Working tree';
                    meta.textContent = 'Live file on disk';
                } else {
                    const commit = _versionHistory[_versionIndex];
                    msg.textContent = commit.message;
                    const shortHash = commit.hash.substring(0, 8);
                    const dateStr = commit.date.split(' ').slice(0, 2).join(' ');
                    meta.textContent = `${shortHash} ¬∑ ${commit.author} ¬∑ ${dateStr}`;
                }

                const total = _versionHistory.length + 1; // +1 for current
                const pos = _versionIndex + 2; // 1-based, current=1
                counter.textContent = `${pos}/${total}`;

                // Prev = go to older version (higher index)
                prevBtn.disabled = (_versionIndex >= _versionHistory.length - 1);
                // Next = go to newer version (lower index, or back to current)
                nextBtn.disabled = (_versionIndex === -1);
            }

            async function navigateVersion(direction) {
                // direction: -1 = newer (toward current), +1 = older
                const newIndex = _versionIndex + direction;
                if (newIndex < -1 || newIndex >= _versionHistory.length) return;

                _versionIndex = newIndex;
                updateVersionNav();
                await loadVersionContent();
            }

            async function loadVersionContent() {
                const body = document.getElementById('modal-body');
                body.innerHTML = '<div class="loading-overlay" style="position:relative;min-height:200px;"><div class="loading-spinner"></div></div>';

                const filePath = _currentFilePath;
                const fileType = _currentFileType;

                try {
                    if (_versionIndex === -1) {
                        // Load current version (from disk)
                        switch (fileType) {
                            case 'csv': await renderCSV(filePath); break;
                            case 'image': renderImage(filePath); break;
                            case 'pdf': renderPDF(filePath); break;
                            case 'text': await renderText(filePath); break;
                            default: body.innerHTML = '<div class="file-not-found"><div class="file-not-found-icon">üì¶</div><div class="file-not-found-text">Binary file</div></div>';
                        }
                        return;
                    }

                    const commit = _versionHistory[_versionIndex].hash;

                    if (fileType === 'csv') {
                        const res = await fetch(`/api/file/at-commit?path=${encodeURIComponent(filePath)}&commit=${commit}`);
                        const data = await res.json();
                        if (data.error) { body.innerHTML = `<div class="file-not-found"><div class="file-not-found-icon">üï∞Ô∏è</div><div class="file-not-found-text">${data.error}</div></div>`; return; }
                        // Render CSV from historical data
                        _csvData = data;
                        _csvSortCol = null; _csvSortAsc = true;
                        const toolbar = document.getElementById('modal-toolbar');
                        const search = document.getElementById('modal-search');
                        const stats = document.getElementById('modal-stats');
                        toolbar.style.display = 'flex';
                        search.value = '';
                        stats.textContent = `${data.total} rows ¬∑ ${data.columns.length} cols`;
                        renderCSVTable('');
                    } else if (fileType === 'image') {
                        body.innerHTML = `<div class="image-viewer"><img src="/api/file/at-commit?path=${encodeURIComponent(filePath)}&commit=${commit}" alt="${filePath}"></div>`;
                    } else if (fileType === 'text') {
                        const res = await fetch(`/api/file/at-commit?path=${encodeURIComponent(filePath)}&commit=${commit}`);
                        const data = await res.json();
                        if (data.error) { body.innerHTML = `<div class="file-not-found"><div class="file-not-found-icon">üï∞Ô∏è</div><div class="file-not-found-text">${data.error}</div></div>`; return; }
                        if (filePath.endsWith('.json')) {
                            try {
                                const parsed = JSON.parse(data.content);
                                body.innerHTML = `<div class="text-viewer">${JSON.stringify(parsed, null, 2)}</div>`;
                            } catch { body.innerHTML = `<div class="text-viewer">${escapeHtml(data.content)}</div>`; }
                        } else {
                            body.innerHTML = `<div class="text-viewer">${escapeHtml(data.content)}</div>`;
                        }
                    } else if (fileType === 'pdf') {
                        body.innerHTML = `<div class="pdf-viewer"><iframe src="/api/file/at-commit?path=${encodeURIComponent(filePath)}&commit=${commit}"></iframe></div>`;
                    } else {
                        body.innerHTML = '<div class="file-not-found"><div class="file-not-found-icon">üì¶</div><div class="file-not-found-text">Preview not available for this version</div></div>';
                    }
                } catch (err) {
                    body.innerHTML = `<div class="file-not-found"><div class="file-not-found-icon">üí•</div><div class="file-not-found-text">Error: ${err.message}</div></div>`;
                }
            }

            // Version nav button events
            document.getElementById('version-prev').addEventListener('click', () => navigateVersion(1));
            document.getElementById('version-next').addEventListener('click', () => navigateVersion(-1));

            async function openFileInspector(filePath) {
                const overlay = document.getElementById('modal-overlay');
                const body = document.getElementById('modal-body');
                const toolbar = document.getElementById('modal-toolbar');
                const search = document.getElementById('modal-search');

                // Reset
                body.innerHTML = '<div class="loading-overlay" style="position:relative;min-height:200px;"><div class="loading-spinner"></div></div>';
                toolbar.style.display = 'none';
                search.value = '';
                overlay.classList.add('visible');

                // Reset version state
                _currentFilePath = filePath;
                _versionHistory = [];
                _versionIndex = -1;
                _currentFileType = null;
                document.getElementById('version-nav').classList.remove('active');

                // Load file info and history in parallel
                try {
                    const [infoRes, _] = await Promise.all([
                        fetch(`/api/file/info?path=${encodeURIComponent(filePath)}`),
                        loadFileHistory(filePath),
                    ]);
                    const info = await infoRes.json();

                    document.getElementById('modal-filename').textContent = info.name || filePath;
                    document.getElementById('modal-badge').textContent = (info.extension || '').replace('.', '').toUpperCase();
                    document.getElementById('modal-icon').textContent = FILE_ICONS[info.type] || 'üìÑ';
                    _currentFileType = info.type;

                    // Show version nav if history exists
                    updateVersionNav();

                    if (!info.exists) {
                        body.innerHTML = `
                    <div class="file-not-found">
                        <div class="file-not-found-icon">üîç</div>
                        <div class="file-not-found-text">File not found (output not yet generated?)</div>
                        <div class="file-not-found-path">${filePath}</div>
                    </div>`;
                        // Even if current doesn't exist, user can navigate to older versions
                        return;
                    }

                    switch (info.type) {
                        case 'csv': await renderCSV(filePath); break;
                        case 'image': renderImage(filePath); break;
                        case 'pdf': renderPDF(filePath); break;
                        case 'text': await renderText(filePath); break;
                        default:
                            body.innerHTML = `
                        <div class="file-not-found">
                            <div class="file-not-found-icon">üì¶</div>
                            <div class="file-not-found-text">Binary file ‚Äî preview not available</div>
                            <div class="file-not-found-path">${filePath}</div>
                        </div>`;
                    }
                } catch (err) {
                    body.innerHTML = `
                <div class="file-not-found">
                    <div class="file-not-found-icon">üí•</div>
                    <div class="file-not-found-text">Error loading file: ${err.message}</div>
                </div>`;
                }
            }

            // ‚îÄ‚îÄ‚îÄ CSV Renderer ‚îÄ‚îÄ‚îÄ
            let _csvData = null;
            let _csvSortCol = null;
            let _csvSortAsc = true;

            async function renderCSV(filePath) {
                const body = document.getElementById('modal-body');
                const toolbar = document.getElementById('modal-toolbar');
                const search = document.getElementById('modal-search');
                const stats = document.getElementById('modal-stats');

                const res = await fetch(`/api/file/csv?path=${encodeURIComponent(filePath)}`);
                _csvData = await res.json();
                _csvSortCol = null;
                _csvSortAsc = true;

                toolbar.style.display = 'flex';
                stats.textContent = `${_csvData.total} rows √ó ${_csvData.columns.length} cols`;

                // Wire up search
                search.oninput = () => renderCSVTable(search.value.toLowerCase());
                renderCSVTable('');
            }

            function renderCSVTable(filter) {
                const body = document.getElementById('modal-body');
                let rows = _csvData.rows;

                // Filter
                if (filter) {
                    rows = rows.filter(row =>
                        Object.values(row).some(v => (v || '').toLowerCase().includes(filter))
                    );
                }

                // Sort
                if (_csvSortCol !== null) {
                    const col = _csvData.columns[_csvSortCol];
                    rows = [...rows].sort((a, b) => {
                        let va = a[col] || '', vb = b[col] || '';
                        const na = parseFloat(va), nb = parseFloat(vb);
                        if (!isNaN(na) && !isNaN(nb)) return _csvSortAsc ? na - nb : nb - na;
                        return _csvSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
                    });
                }

                const isNumeric = (val) => val !== '' && !isNaN(parseFloat(val));

                let html = '<div class="csv-table-wrap"><table class="csv-table"><thead><tr>';
                _csvData.columns.forEach((col, i) => {
                    const sorted = _csvSortCol === i;
                    const arrow = sorted ? (_csvSortAsc ? '‚ñ≤' : '‚ñº') : '‚ñ≤';
                    html += `<th class="${sorted ? 'sorted' : ''}" data-col="${i}">${col}<span class="sort-arrow">${arrow}</span></th>`;
                });
                html += '</tr></thead><tbody>';

                const displayRows = rows.slice(0, 500); // Cap display at 500
                for (const row of displayRows) {
                    html += '<tr>';
                    for (const col of _csvData.columns) {
                        const val = row[col] || '';
                        html += `<td class="${isNumeric(val) ? 'numeric' : ''}">${val}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';

                if (rows.length > 500) {
                    html += `<div style="padding:12px 24px;font-size:12px;color:var(--text-muted);">Showing 500 of ${rows.length} rows</div>`;
                }

                body.innerHTML = html;

                // Update stats
                document.getElementById('modal-stats').textContent =
                    filter ? `${rows.length} of ${_csvData.total} rows` : `${_csvData.total} rows √ó ${_csvData.columns.length} cols`;

                // Wire sort clicks
                body.querySelectorAll('.csv-table th').forEach(th => {
                    th.addEventListener('click', () => {
                        const col = parseInt(th.dataset.col);
                        if (_csvSortCol === col) _csvSortAsc = !_csvSortAsc;
                        else { _csvSortCol = col; _csvSortAsc = true; }
                        renderCSVTable(document.getElementById('modal-search').value.toLowerCase());
                    });
                });
            }

            // ‚îÄ‚îÄ‚îÄ Image Renderer ‚îÄ‚îÄ‚îÄ
            function renderImage(filePath) {
                const body = document.getElementById('modal-body');
                body.innerHTML = `<div class="image-viewer"><img src="/api/file/raw?path=${encodeURIComponent(filePath)}" alt="${filePath}"></div>`;
            }

            // ‚îÄ‚îÄ‚îÄ PDF Renderer ‚îÄ‚îÄ‚îÄ
            function renderPDF(filePath) {
                const body = document.getElementById('modal-body');
                body.innerHTML = `<div class="pdf-viewer"><iframe src="/api/file/raw?path=${encodeURIComponent(filePath)}"></iframe></div>`;
            }

            // ‚îÄ‚îÄ‚îÄ Text Renderer ‚îÄ‚îÄ‚îÄ
            async function renderText(filePath) {
                const body = document.getElementById('modal-body');
                const res = await fetch(`/api/file/text?path=${encodeURIComponent(filePath)}`);
                const data = await res.json();

                if (filePath.endsWith('.json')) {
                    try {
                        const parsed = JSON.parse(data.content);
                        body.innerHTML = `<div class="text-viewer">${JSON.stringify(parsed, null, 2)}</div>`;
                    } catch {
                        body.innerHTML = `<div class="text-viewer">${escapeHtml(data.content)}</div>`;
                    }
                } else {
                    body.innerHTML = `<div class="text-viewer">${escapeHtml(data.content)}</div>`;
                }
            }

            function escapeHtml(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }

            // ‚îÄ‚îÄ‚îÄ Modal close ‚îÄ‚îÄ‚îÄ
            document.getElementById('modal-close').addEventListener('click', () => {
                document.getElementById('modal-overlay').classList.remove('visible');
            });
            document.getElementById('modal-overlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('modal-overlay').classList.remove('visible');
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('modal-overlay').classList.remove('visible');
                }
            });

            // ‚îÄ‚îÄ‚îÄ Run Pipeline / Stage ‚îÄ‚îÄ‚îÄ
            let selectedStage = null;
            let isRunning = false;
            let stageLogs = {};  // {stageId: 'log lines...'}
            let _errorStages = new Set();  // stages that failed ‚Äî keep red until next run
            let _updatedOutputs = new Set();  // output files produced in last run
            let _stageTimers = {};  // {stageId: {start: Date.now(), duration: ms}}
            let _toastInterval = null;  // interval for live elapsed time in toast
            let _nodeBadgeEls = {};  // {stageId: DOM element} for node overlay badges

            const INSPECTABLE_EXTS = ['.csv', '.tsv', '.png', '.jpg', '.jpeg', '.gif', '.webp', '.svg', '.bmp', '.pdf', '.json', '.yaml', '.yml', '.txt', '.md', '.log', '.jsonl'];
            const isInspectable = (path) => INSPECTABLE_EXTS.some(ext => path.toLowerCase().endsWith(ext));

            // Toast helpers
            function showToast(text, type = 'running') {
                const toast = document.getElementById('exec-toast');
                const spinner = document.getElementById('toast-spinner');
                const icon = document.getElementById('toast-icon');
                document.getElementById('toast-text').textContent = text;
                toast.className = 'exec-toast active' + (type !== 'running' ? ' ' + type : '');
                spinner.style.display = type === 'running' ? 'block' : 'none';
                icon.style.display = type !== 'running' ? 'inline' : 'none';
                icon.textContent = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '';
            }

            function hideToast() {
                document.getElementById('exec-toast').classList.remove('active');
                if (_toastInterval) { clearInterval(_toastInterval); _toastInterval = null; }
            }

            function formatElapsed(ms) {
                const s = Math.floor(ms / 1000);
                if (s < 60) return `${s}s`;
                const m = Math.floor(s / 60);
                const rs = s % 60;
                if (m < 60) return `${m}m ${rs.toString().padStart(2, '0')}s`;
                const h = Math.floor(m / 60);
                const rm = m % 60;
                return `${h}h ${rm.toString().padStart(2, '0')}m`;
            }

            // ‚îÄ‚îÄ‚îÄ Node badges (floating "NEW" pills on graph) ‚îÄ‚îÄ‚îÄ
            function addNodeBadge(stageId) {
                if (_nodeBadgeEls[stageId]) return;  // already exists
                if (!cy) return;
                const node = cy.getElementById(stageId);
                if (!node.length) return;

                const badge = document.createElement('div');
                badge.className = 'node-badge';
                badge.textContent = 'NEW';
                document.getElementById('node-badges-layer').appendChild(badge);
                _nodeBadgeEls[stageId] = badge;
                positionBadge(stageId);
            }

            function removeNodeBadge(stageId) {
                const badge = _nodeBadgeEls[stageId];
                if (badge) {
                    badge.remove();
                    delete _nodeBadgeEls[stageId];
                }
            }

            function clearAllNodeBadges() {
                for (const id of Object.keys(_nodeBadgeEls)) {
                    removeNodeBadge(id);
                }
            }

            function positionBadge(stageId) {
                const badge = _nodeBadgeEls[stageId];
                if (!badge || !cy) return;
                const node = cy.getElementById(stageId);
                if (!node.length) return;
                const pos = node.renderedPosition();
                const h = node.renderedHeight ? node.renderedHeight() / 2 : 20;
                badge.style.left = pos.x + 'px';
                badge.style.top = (pos.y - h - 4) + 'px';
            }

            function repositionNodeBadges() {
                for (const id of Object.keys(_nodeBadgeEls)) {
                    positionBadge(id);
                }
            }

            // Per-node animation
            function startSingleNodeAnimation(stageId) {
                if (!cy) return;
                const node = cy.getElementById(stageId);
                if (!node.length) return;
                node.scratch('_origBg', node.data('bgColor'));
                node.scratch('_origBorder', node.data('borderColor'));
                node.scratch('_origGlow', node.data('glowColor'));
                node.scratch('_animating', true);

                // Immediately set a vivid running color
                node.data('bgColor', 'rgba(34, 211, 238, 0.12)');
                node.data('borderColor', '#22d3ee');
                node.data('glowColor', 'rgba(34, 211, 238, 0.7)');

                function pulse() {
                    if (!node.scratch('_animating')) return;
                    node.animate({
                        style: {
                            'background-color': 'rgba(34, 211, 238, 0.18)',
                            'border-color': '#22d3ee',
                            'border-width': 3,
                            'shadow-color': 'rgba(34, 211, 238, 0.9)',
                            'shadow-blur': 40,
                            'shadow-opacity': 1,
                        },
                    }, {
                        duration: 700,
                        complete: () => {
                            if (!node.scratch('_animating')) return;
                            node.animate({
                                style: {
                                    'background-color': 'rgba(34, 211, 238, 0.06)',
                                    'border-color': '#06b6d4',
                                    'border-width': 2,
                                    'shadow-color': 'rgba(6, 182, 212, 0.3)',
                                    'shadow-blur': 15,
                                    'shadow-opacity': 0.4,
                                },
                            }, {
                                duration: 700,
                                complete: pulse,
                            });
                        },
                    });
                }
                pulse();
            }

            function stopSingleNodeAnimation(stageId, success = true) {
                if (!cy) return;
                const node = cy.getElementById(stageId);
                if (!node.length) return;
                node.scratch('_animating', false);
                node.stop(true, true);

                if (success) {
                    // Restore to valid colors
                    const sc = STATE_COLORS.valid;
                    node.data({ bgColor: sc.bg, borderColor: sc.border, glowColor: sc.glow });
                    node.style({
                        'background-color': sc.bg,
                        'border-color': sc.border,
                        'border-width': 2,
                        'shadow-color': sc.glow,
                        'shadow-blur': 20,
                        'shadow-opacity': 0.6,
                    });
                } else {
                    // Error: red colors
                    node.data({
                        bgColor: 'rgba(239, 68, 68, 0.15)',
                        borderColor: '#ef4444',
                        glowColor: 'rgba(239, 68, 68, 0.6)',
                    });
                    node.style({
                        'background-color': 'rgba(239, 68, 68, 0.15)',
                        'border-color': '#ef4444',
                        'border-width': 2,
                        'shadow-color': 'rgba(239, 68, 68, 0.6)',
                        'shadow-blur': 20,
                        'shadow-opacity': 0.8,
                    });
                }
            }

            async function runPipeline(stage = null) {
                if (isRunning) return;
                isRunning = true;

                const allBtn = document.getElementById('btn-run-all');
                const stageBtn = document.getElementById('btn-run-stage');
                allBtn.classList.add('running');
                allBtn.disabled = true;
                stageBtn.classList.add('running');
                stageBtn.disabled = true;

                // Clear previous logs, error states, and updated outputs
                _errorStages.clear();
                _updatedOutputs.clear();
                _stageTimers = {};
                clearAllNodeBadges();
                if (!stage) {
                    stageLogs = {};  // Clear all when running full pipeline
                } else {
                    stageLogs[stage] = '';
                }

                const label = stage ? `Running: ${stage}` : 'Running pipeline‚Ä¶';
                showToast(label, 'running');

                // Build SSE URL
                let url = '/api/run-stream?';
                if (stage) url += `stage=${encodeURIComponent(stage)}&`;
                url += 'force=false';

                try {
                    const res = await fetch(url);
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let currentStage = null;
                    let pipelineSuccess = true;
                    let failedStage = null;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line

                        let eventType = null;
                        for (const line of lines) {
                            if (line.startsWith('event: ')) {
                                eventType = line.slice(7).trim();
                            } else if (line.startsWith('data: ') && eventType) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    handleSSEEvent(eventType, data);
                                } catch (e) { /* ignore parse errors */ }
                                eventType = null;
                            }
                        }
                    }

                    function handleSSEEvent(type, data) {
                        switch (type) {
                            case 'stage_start':
                                currentStage = data.stage;
                                if (!stageLogs[data.stage]) stageLogs[data.stage] = '';
                                _stageTimers[data.stage] = { start: Date.now(), duration: null };
                                showToast(`Running: ${data.stage}`, 'running');
                                // Live elapsed timer in toast
                                if (_toastInterval) clearInterval(_toastInterval);
                                _toastInterval = setInterval(() => {
                                    const t = _stageTimers[data.stage];
                                    if (t && !t.duration) {
                                        const elapsed = formatElapsed(Date.now() - t.start);
                                        document.getElementById('toast-text').textContent = `Running: ${data.stage} (${elapsed}‚Ä¶)`;
                                    }
                                }, 1000);
                                try { startSingleNodeAnimation(data.stage); } catch (e) { }
                                break;

                            case 'stage_skip':
                                if (!stageLogs[data.stage]) stageLogs[data.stage] = '';
                                stageLogs[data.stage] += `[skipped ‚Äî no changes]\n`;
                                break;

                            case 'log':
                                if (data.stage && data.line !== undefined) {
                                    if (!stageLogs[data.stage]) stageLogs[data.stage] = '';
                                    stageLogs[data.stage] += data.line + '\n';
                                }
                                // Update sidebar if this stage is currently selected
                                if (data.stage && data.stage === selectedStage) {
                                    const logPre = document.querySelector('.sidebar-logs-content');
                                    if (logPre) {
                                        logPre.textContent = stageLogs[data.stage];
                                        logPre.scrollTop = logPre.scrollHeight;
                                    }
                                }
                                break;

                            case 'stage_done':
                                // Record duration
                                if (_stageTimers[data.stage]) {
                                    _stageTimers[data.stage].duration = Date.now() - _stageTimers[data.stage].start;
                                }
                                if (_toastInterval) { clearInterval(_toastInterval); _toastInterval = null; }
                                try {
                                    stopSingleNodeAnimation(data.stage, data.success);
                                } catch (e) { }
                                if (!data.success) {
                                    pipelineSuccess = false;
                                    failedStage = data.stage;
                                    _errorStages.add(data.stage);
                                }
                                // Mark outputs of this stage as updated
                                if (data.success && cy) {
                                    const n = cy.getElementById(data.stage);
                                    if (n.length) {
                                        const outs = n.data('outs') || [];
                                        const metrics = n.data('metrics') || [];
                                        const plots = n.data('plots') || [];
                                        const allFiles = [...outs, ...metrics, ...plots];
                                        allFiles.forEach(o => {
                                            const p = typeof o === 'string' ? o : o.path;
                                            if (p) _updatedOutputs.add(p);
                                        });

                                        // Only add badge if there are inspectable files
                                        const hasInspectable = allFiles.some(o => {
                                            const p = typeof o === 'string' ? o : o.path;
                                            return p && isInspectable(p);
                                        });
                                        if (hasInspectable) addNodeBadge(data.stage);
                                    }
                                }
                                // Refresh sidebar to show updated file statuses
                                refreshPipeline();
                                break;

                            case 'done':
                                pipelineSuccess = data.success;
                                if (data.failed_stage) failedStage = data.failed_stage;
                                break;
                        }
                    }

                    // Final UI update
                    if (pipelineSuccess) {
                        showToast('Pipeline completed ‚úì', 'success');
                    } else {
                        showToast(`Failed: ${failedStage || 'unknown stage'}`, 'error');
                    }
                    setTimeout(hideToast, 4000);

                    // Refresh pipeline data
                    await refreshPipeline();

                } catch (err) {
                    showToast('Error: ' + err.message, 'error');
                    setTimeout(hideToast, 5000);
                } finally {
                    isRunning = false;
                    allBtn.classList.remove('running');
                    allBtn.disabled = false;
                    stageBtn.classList.remove('running');
                    stageBtn.disabled = false;
                    // Stop any remaining animations
                    if (cy) cy.nodes().forEach(n => {
                        if (n.scratch('_animating')) {
                            n.scratch('_animating', false);
                            n.stop(true, true);
                        }
                    });
                }
            }

            async function refreshPipeline() {
                try {
                    const res = await fetch('/api/pipeline');
                    const data = await res.json();
                    if (data.error) return;

                    // Update node data (colors driven by data mappers in stylesheet)
                    for (const node of data.nodes) {
                        const cyNode = cy.getElementById(node.id);
                        if (cyNode.length) {
                            // Skip color reset for error stages OR currently animating stages
                            if (_errorStages.has(node.id) || cyNode.scratch('_animating')) {
                                cyNode.data({
                                    state: node.state,
                                    deps: node.deps,
                                    outs: node.outs,
                                    metrics: node.metrics,
                                    plots: node.plots,
                                });
                                continue;
                            }
                            const sc = STATE_COLORS[node.state] || STATE_COLORS.never_run;
                            cyNode.data({
                                state: node.state,
                                deps: node.deps,
                                outs: node.outs,
                                metrics: node.metrics,
                                plots: node.plots,
                                bgColor: sc.bg,
                                borderColor: sc.border,
                                textColor: sc.text,
                                glowColor: sc.glow,
                            });
                        }
                    }

                    // Update stats bar
                    updateStats(data);

                    // If a stage is selected, refresh its sidebar
                    if (selectedStage) {
                        const updatedNode = data.nodes.find(n => n.id === selectedStage);
                        if (updatedNode) showDetail(updatedNode);
                    }
                } catch (err) {
                    console.error('Failed to refresh pipeline:', err);
                }
            }

            // Run All button
            document.getElementById('btn-run-all').addEventListener('click', () => runPipeline(null));

            // Run Stage button
            document.getElementById('btn-run-stage').addEventListener('click', () => {
                if (selectedStage) runPipeline(selectedStage);
            });

            boot();

            // ‚îÄ‚îÄ‚îÄ Sidebar resize ‚îÄ‚îÄ‚îÄ
            (function () {
                const handle = document.getElementById('sidebar-resize');
                const sidebar = document.getElementById('sidebar');
                let startX, startW;

                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startX = e.clientX;
                    startW = sidebar.offsetWidth;
                    handle.classList.add('active');
                    sidebar.style.transition = 'none';

                    function onMove(e) {
                        const delta = startX - e.clientX;
                        const newW = Math.min(Math.max(startW + delta, 260), window.innerWidth * 0.6);
                        sidebar.style.width = newW + 'px';
                    }

                    function onUp() {
                        handle.classList.remove('active');
                        sidebar.style.transition = '';
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                        // Resize cytoscape
                        if (cy) cy.resize();
                    }

                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });
            })();
        })();
    </script>
</body>

</html>